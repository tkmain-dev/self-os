# フロントエンド構成

## ルーティング

React Router v7 によるクライアントサイドルーティング。`Layout` コンポーネントが全ページを包む。

| パス | コンポーネント | 説明 |
|------|---------------|------|
| `/` | → `/daily` リダイレクト | |
| `/daily` | `DailyPage` | デイリーページ |
| `/calendar` | `CalendarPage` | カレンダー |
| `/goals` | `GoalGantt` | 目標管理 |
| `/wishlist` | `WishListPage` | ウィッシュリスト |

## コンポーネント一覧

### Layout.tsx

共通レイアウト。左サイドバー（ナビゲーション4項目 + 歯車ボタン）+ メインエリア。

- サイドバーに今日の日付を表示
- アクティブなページをハイライト
- 歯車ボタンで `AdminModal` を開く

### DailyPage.tsx

1日の予定・習慣・日記を一画面で表示するメインページ。

- **日付ヘッダー**: 前日・翌日・今日ボタン + `MonthlyGoalBadge`（今月の目標をインライン表示）
- **スケジュールタイムライン**: 6:00〜翌1:00 の時間軸グリッド（19時間表示、生活時間7:00〜24:00+前後バッファ）。現在時刻インジケーター付き
  - マウスドラッグでイベントの移動・リサイズ（ゴーストオーバーレイ表示）
  - **タイムラインクリック→スケジュール作成**: 空き時間クリックで `ScheduleCreateModal` がポップアップ。クリック位置を15分スナップで開始時刻にプリフィル（終了は+1時間）。ドラッグ操作との誤判定防止付き
  - 習慣リストからのドラッグ＆ドロップでスケジュール作成（`source: 'habit'` として登録）
  - WBSチケット（タスク/サブタスク）の時間設定済みアイテムをsky色+WBSバッジで統合表示（読み取り専用）
  - ルーティン背景ブロック: 当日曜日に該当するルーティンをteal色の破線枠で背景表示（z-1、pointer-events-none）。メモが設定されている場合は右上にinfoアイコンボタンを表示し、クリックでダークテーマのポップオーバーに実施内容・注意点を表示
- **習慣セクション（HabitSection）**: 当日に設定されている子習慣のみをリスト表示
  - `⚙ 管理` ボタンで `HabitManagerModal` を開く
  - グループ（親習慣あり）は箱型コンテナで視覚的にグルーピング
  - 各習慣にドラッグハンドル（タイムラインへのD&D）と完了トグルを表示
- **日記セクション**: `Diary` コンポーネントを埋め込み
- 日付ナビゲーション（前日・翌日・今日ボタン）

#### MonthlyGoalBadge

ヘッダー右側にインライン配置される今月の目標コンポーネント。

- 通常表示: `✦ [目標テキスト]` をアンバーボールドで表示（宣言スタイル）
- 編集モード: ✎ ボタンクリックで切替。単行テキスト入力、Enter で保存・Escape でキャンセル
- `/api/monthly-goals` API と連携
- `date` プロップで表示中の日付を受け取り、その月の目標を表示・編集（日付ナビゲーション連動）

#### WeeklyGoalSection（DailyPage 内）

ヘッダーと2カラムコンテンツの間に配置される今週の目標コンポーネント。

- 通常表示: 旗アイコン + 週番号（W09）+ 目標テキストをコンパクトなバーで表示
- 詳細表示: シェブロンアイコンクリックでインライン展開（スライドダウンアニメーション）。amberグラデーション背景 + 左側に縦線アクセント。`react-markdown` + `remark-gfm` によるMarkdownレンダリング（テーブル・リスト・コード対応）
- 編集モード: ペンアイコン（ホバーで出現）クリックで目標テキスト + 詳細メモのフォーム表示（Markdown記法で入力）
- `/api/weekly-goals` API と連携（ISO週番号キー、例: `2026-W08`）

#### HabitSection（DailyPage 内）

当日に実行設定されている葉習慣（子習慣）のみを表示するリスト。

- `day_of_week` で当日の曜日番号を含む習慣のみ抽出
- `parent_id` を持つ習慣はグループ箱（ヘッダー + 子リスト）として表示
- `parent_id = null` のスタンドアロン習慣は個別カードとして表示
- 各習慣アイテム: ドラッグハンドル `⠿` / 習慣名 / 所要時間バッジ / 完了トグル

#### HabitManagerModal（DailyPage 内）

習慣の作成・編集・削除を行うモーダル。

- **左パネル**: 習慣ツリー一覧 + 追加フォーム（カスタムドロップダウンでグループ選択）
- **右パネル**: 選択した習慣の編集
  - 葉習慣: `HabitEditPanel`（所要時間ステッパー + 曜日サークルトグル）
  - グループ習慣: 名前のみ編集（曜日・時間設定なし）

#### HabitEditPanel（DailyPage 内）

葉習慣の詳細設定フォーム。

- **所要時間**: プリセットボタン（15/30/45/60/90/120分）+ `−`/`+` ステッパー（5分刻み）
- **実行曜日**: 円形ボタン × 7曜日 + クイック選択（平日/週末/毎日/クリア）

### Diary.tsx

BlockNote リッチテキストエディタによる日記コンポーネント。

- BlockNote エディタ（ダークテーマ対応）
- 5秒デバウンスの自動保存
- JSON / Markdown 両形式の後方互換パース
- 手動保存ボタン + 保存ステータス表示

### GoalGantt.tsx

WBS ベースのガントチャートで目標を階層管理する。最も複雑なコンポーネント。

- **階層構造**: Epic > Story > Task > Subtask の4階層ツリー
- **ガントチャート**: 1ヶ月 / 3ヶ月 / 6ヶ月 / 1年の表示レンジ切替（今日基準の相対表示、左マージン約20%）
- **ヘッダー固定**: カラムヘッダー（左）+ 月名・日付ラベル（右）を `sticky top-0 z-20` で統合し、スクロール時も常に表示
- **日付計算**: `formatDate` はローカル時刻ベース（`getFullYear/getMonth/getDate`）でタイムゾーン (JST 等) の影響を受けない
- **マイルストーン**: Story チケットに `milestone_date` / `milestone_label` を設定可能。Gantt 上に金色の破線縦線 + ダイヤモンドマーカー（グロー付き）で表示、ホバーでツールチップ表示。縦線は親 Epic のサブツリー行範囲内に制限（`epicAncestorOf` useMemo で先祖 Epic を計算）
- **ドラッグ操作**:
  - バーのリサイズ（左端・右端）で期間変更
  - バーの移動で期間シフト
  - 行のドラッグで並替・親子関係変更
- **タイトルクリック → 詳細モーダル**: `TicketDetailModal` を開き、メタデータ編集 + ノート記入
- **✎ ボタン → クイック編集モーダル**: 従来のコンパクトな編集フォーム
- **インライン編集**: ステータスドロップダウン
- **進捗管理**: 子目標からの自動計算
- **折りたたみ**: ツリーノードの展開・折りたたみ

### TicketDetailModal.tsx

チケット詳細モーダル。タイトルクリックで開く大型モーダル。

- **メタデータ編集**: タイトル（インライン編集）、Type/Status/Priority（セレクト）、カテゴリ、日付、カラー
  - 各フィールドは変更時に即座に `apiPatch` で保存
- **スケジュール設定**（タスク/サブタスクのみ）: 開始時刻（time picker）+ 所要時間（プリセット30/60/90/120分 + カスタム15分刻み）+ クリアボタン
  - `scheduled_time`（HH:mm）と `scheduled_duration`（分）を goals テーブルに保存
  - 設定されたチケットはカレンダーのタイムグリッドおよびデイリーページのスケジュールタイムラインに表示
- **マイルストーン設定**（Story のみ）: `DatePickerPopover`（カスタムカレンダー UI）で日付選択 + ラベルテキスト入力。変更は即座に `patchField` で保存
- **ノートエディタ**: BlockNote リッチテキストエディタ（Diary.tsx と同じライブラリ）
  - 見出し、箇条書き、コードブロック等のリッチテキスト入力
  - 5秒デバウンスの自動保存 + 手動保存ボタン
  - 保存ステータス表示（「保存しました」/「未保存の変更あり」）
  - モーダルを閉じる時に未保存の変更があれば自動保存
- **安定性設計**: モーダルが開いている間は `refetch()` を呼ばず、エディタの状態を保護。閉じる時にのみ親の Gantt を同期

### CalendarPage.tsx（+ calendar/ 配下）

月・週・日の3ビューカレンダー。スケジュールと目標を統合表示。

- **タイムグリッド表示範囲**: 7:00〜翌3:00（20時間）。深夜帯は「翌」プレフィックス付きラベル。24:00に日付境界の破線ライン。初期スクロール位置は9:00
- **時刻付きチケット表示**: `scheduled_time` が設定されたタスク/サブタスクはバンドから除外し、タイムグリッド（週・日ビュー）または日セル（月ビュー）にスケジュールと同様に表示。sky色の四角ドット + 時刻表示で予定と視覚的に区別
- **ルーティン背景表示**: 週・日ビューのタイムグリッドに、曜日が一致するルーティンをteal色の破線枠で背景表示（補助的ガイド、操作干渉なし）。メモ付きルーティンはinfoアイコンからポップオーバー表示
- **目標バンド**: 葉タスク（子を持たないタスク）のみをフラット表示。親タスクの帯は非表示
  - Epic 祖先がある場合: 紫の角丸バッジ `[Epic名]` をプレフィックス表示
  - Story 祖先がある場合: `Story名 /` を薄い色でプレフィックス表示
  - Task/Subtask 親は非表示（Epic・Story のみ表示）
  - ホバー時のツールチップには `Epic / Story / タスク名` のフルパスを表示

| ファイル | 役割 |
|---------|------|
| `CalendarPage.tsx` | メイン。データ取得、ビュー切替、モーダル管理 |
| `CalendarHeader.tsx` | ヘッダー（ビュー切替ボタン、期間ナビゲーション、今日ボタン） |
| `CalendarMonthView.tsx` | 月ビュー（日セルグリッド + バンド表示） |
| `CalendarWeekView.tsx` | 週ビュー（時間軸グリッド + 目標バンド） |
| `CalendarDayView.tsx` | 日ビュー（詳細タイムライン + 目標バンド） |
| `CalendarDayCell.tsx` | 月ビュー用の各日セル |
| `CalendarTimeGrid.tsx` | 時間軸グリッド（週・日ビュー共通） |
| `CalendarEventItem.tsx` | スケジュールイベント表示 |
| `CalendarGoalItem.tsx` | 目標バンド表示 |
| `CalendarFormModal.tsx` | スケジュール作成・編集モーダル（`prefilledStartTime`/`prefilledEndTime` でスロットクリック時の時刻プリフィル対応） |
| `calendarTypes.ts` | 型定義（ScheduleItem, GoalItem, CalendarEvent, BandSegment（epicTitle/storyTitle付き）） |
| `calendarUtils.ts` | ユーティリティ関数（collectLeaves で葉タスク抽出 + Epic/Story 祖先情報） |

### WishListPage.tsx

「買いたいもの」と「やりたいこと」の2タブ管理ページ。

- **タブ切替**: wish（amber テーマ）/ bucket（teal-violet テーマ）
- **カード UI**: タイトル、価格（wish のみ）、URL、期限、メモ
- **ドラッグ並替**: HTML5 Drag and Drop で優先順位変更
- **詳細展開**: カードクリックでインライン展開。フルURL・期限・価格・メモをSVGアイコン付きで表示。シェブロンアイコンで展開/折りたたみ状態を視覚表示
- **チケット化モーダル**: bucket アイテムから目標管理の Story を作成（Epic 選択 or 新規作成）
- **日記パネル**: 編集中に右側に日記を表示（`DiaryChecklist` 使用）
- **統計表示**: 完了数、合計金額（wish）
- **完了アーカイブ**: 完了アイテムはメインリストから分離し、折りたたみ式「完了済み (N)」ブロックに表示。`done_at` 日付でグループ化（新しい順）。完了取消ボタンでロールバック可能
- 日付入力に `DatePicker` コンポーネントを使用

### AdminModal.tsx

管理モーダル。サイドバーの歯車ボタンから開く。

- **タブ切替**: Feature Requests / ルーティンの2タブ構成
- **3パネル構成**（FRタブ）: 左（完了済み一覧）| 中央（アクティブ一覧）| 右（日記パネル）
- **Feature Request CRUD**: 作成・編集・削除・ステータス変更
- **ステータスバッジ**: pending=グレー, in_progress=amber, done=green, rejected=red
- **ドラッグ並替**: 優先順位変更
- **完了済み分離**: done / rejected の項目は左パネルに分離表示
- **コミットメッセージ記録**: 完了済み項目の詳細パネルに Commit セクション表示（未記録時は「未記録」プレースホルダー）
- **日記グレーアウト**: モーダルを閉じる際に `DiaryChecklist` の flush を実行してからアンマウント（`flushRef` パターン）
- **ルーティン管理パネル**: 名前・時間帯（time picker）・曜日（サークルトグル）・メモ（実施内容・注意点）の設定CRUD + ドラッグ並替
  - `routines` テーブル（name, start_time, end_time, day_of_week, sort_order, memo）
  - 設定されたルーティンはデイリーページとカレンダーのタイムグリッドに背景ブロックとして表示
  - メモが設定されたルーティンはタイムライン上でinfoアイコンからポップオーバー表示可能
- `GearButton` コンポーネントもエクスポート（Layout で使用）

### DiaryChecklist.tsx

管理モーダル・ウィッシュリストページの右パネルで使用する日記チェックリストコンポーネント。

- BlockNote 日記の各行をチェックボックスとして表示
- チェックを付けると該当行をグレーアウト（BlockNote ブロックの `props.textColor = 'gray'`）
- モーダルを閉じる前に flush（保存）できる `flushRef` prop を受け取る
- `index.css` の `[data-text-color=gray]` セレクタでグレーアウト色を制御（`rgba(155,154,151,0.18)`）

### DatePicker.tsx

日付入力用のカレンダーピッカーコンポーネント。

- クリックでカレンダーをポップアップ表示
- 月ナビゲーション（前月・翌月）
- ダークテーマ対応
- WishListPage・その他の日付入力欄で使用

### その他のコンポーネント

| ファイル | 役割 |
|---------|------|
| `HabitTracker.tsx` | スタンドアロン習慣トラッカー（7日間チェックマトリクス、親子階層・折りたたみ対応） |
| `Schedule.tsx` | スタンドアロンスケジュール表示（タイムライン） |
| `TodoList.tsx` | ToDo リスト（追加・完了トグル・削除） |

## カスタムフック

### useApi.ts

API 通信の共通ロジック。

```typescript
// データ取得
const { data, loading, refetch } = useApi<Goal[]>('/api/goals');

// 書き込み操作
await apiPost('/api/goals', { title: '...', start_date: '...' });
await apiPatch('/api/goals/1', { status: 'done' });
await apiPut('/api/diary/2024-01-01', { content: '...' });
await apiDelete('/api/goals/1');
```

## スタイリング

### デザインシステム

`src/index.css` で CSS カスタムプロパティによるダークモダンテーマを定義。

- **背景**: `#0e0e12`（メイン）/ `#16161e`（カード）
- **テキスト**: `#e4e4ec`（主）/ `#8b8b9e`（副）/ `#5a5a6e`（補助）
- **アクセント**: amber-500
- **ボーダー**: `#2a2a3a`
- **シャドウ**: CSS カスタムプロパティで定義

### カスタムクラス

| クラス | 用途 |
|--------|------|
| `.sidebar` | サイドバースタイル |
| `.sidebar-link` / `.sidebar-link.active` | ナビゲーションリンク |
| `.page-area` | メインコンテンツエリア |
| `.techo-heading` | アンダーライン付き見出し |

### タブ別テーマ（WishListPage）

ウィッシュリストでは `theme` オブジェクトでタブごとに異なるスタイルを適用:

| プロパティ | Wish (amber) | Bucket (teal-violet) |
|-----------|-------------|---------------------|
| カード背景 | `bg-[#16161e]` | グラデーション |
| 角丸 | `rounded-xl` | `rounded-2xl` |
| 左アクセント | amber | teal |
| ヘッダー | amber グラデーション | teal-violet グラデーション |
